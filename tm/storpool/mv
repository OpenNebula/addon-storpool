#!/bin/bash

# -------------------------------------------------------------------------- #
# Copyright 2015-2016, StorPool (storpool.com)                               #
#                                                                            #
# Portions copyright OpenNebula Project (OpenNebula.org), CG12 Labs          #
#                                                                            #
# Licensed under the Apache License, Version 2.0 (the "License"); you may    #
# not use this file except in compliance with the License. You may obtain    #
# a copy of the License at                                                   #
#                                                                            #
# http://www.apache.org/licenses/LICENSE-2.0                                 #
#                                                                            #
# Unless required by applicable law or agreed to in writing, software        #
# distributed under the License is distributed on an "AS IS" BASIS,          #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   #
# See the License for the specific language governing permissions and        #
# limitations under the License.                                             #
#--------------------------------------------------------------------------- #

#-------------------------------------------------------------------------------
# mv host:remote_datastore/disk.i host:remote_datastore/disk.i vmId datastoreId
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Get mv arguments from OpenNebula core
#-------------------------------------------------------------------------------

SRC="$1"
DST="$2"
VM_ID="$3"
DS_ID="$4"

TM_PATH="$(dirname $0)"
source "${TM_PATH}/storpool_common.sh"

splog "SRC=$SRC DST=$DST VM_ID=$VM_ID DS_ID=$DS_ID"

#-------------------------------------------------------------------------------
# Process source and destination
#-------------------------------------------------------------------------------
SRC_PATH=`arg_path $SRC`
SRC_HOST=`arg_host $SRC`
DST_PATH=`arg_path $DST`
DST_HOST=`arg_host $DST`
DST_DIR=`dirname $DST_PATH`

DISK_ID=$(echo "$DST_PATH" | $AWK -F. '{print $NF}')
IS_DISK=`is_disk $DST_PATH`

#-------------------------------------------------------------------------------
# Get Datastore information
#-------------------------------------------------------------------------------
oneDatastoreInfo "$DS_ID"

#-------------------------------------------------------------------------------
# Get VM information
#-------------------------------------------------------------------------------
oneVmInfo "$VM_ID" "$DISK_ID"

SP_VOL="${SOURCE##*/}"
if [ "$CLONE" = "YES" ]; then
    SP_VOL+="-${VM_ID}-${DISK_ID}"
fi

SP_LINK="/dev/storpool/$SP_VOL"
SP_TEMPLATE="${SOURCE%%/*}"

log "vm $VM_ID moving $SRC to $DST"

# is checkpoint on storpool enabled?
case "$SP_CHECKPOINT" in
    yes)
        SP_CHECKPOINT="migrate"
    ;;
    nomigrate)
        SP_CHECKPOINT="yes"
    ;;
    *)
        SP_CHECKPOINT=
        CHECKPOINT_SAVE=
        CHECKPOINT_RESTORE=
    ;;
esac

MIGRATE_UNKNOWN=
DETACH_ALL=
DO_SYMLINK=
SKIP_CONTEXT=
case "$LCM_STATE" in
    8)
        #-----------------------------------------------------------------------
        # migrate checkpoint on PROLOG_MIGRATE
        #-----------------------------------------------------------------------
        if [ "$SP_CHECKPOINT" = "migrate" ]; then
            CHECKPOINT_SAVE="yes"
            CHECKPOINT_RESTORE="yes"
        fi
    ;;
    9)
        #-----------------------------------------------------------------------
        # only attach and restore checkpoint on PROLOG_RESUME
        #-----------------------------------------------------------------------
        ATTACH_ONLY="ATTACH_ONLY (LCM_STATE=$LCM_STATE PROLOG_RESUME)"
        if [ -n "$SP_CHECKPOINT" ]; then
            CHECKPOINT_RESTORE="yes"
        fi
    ;;
    10)
        #-----------------------------------------------------------------------
        # only detach and save checkpoint on EPILOG_STOP
        #-----------------------------------------------------------------------
        DETACH_ONLY="DETACH_ONLY (LCM_STATE=$LCM_STATE EPILOG_STOP)"
        if [ -n "$SP_CHECKPOINT" ]; then
            CHECKPOINT_SAVE="yes"
        fi
    ;;
    30)
        #-----------------------------------------------------------------------
        # only detach (all clients) on EPILOG_UNDEPLOY
        #-----------------------------------------------------------------------
        DETACH_ONLY="DETACH_ONLY (LCM_STATE=$LCM_STATE EPILOG_UNDEPLOY)"
        DETACH_ALL="all"
    ;;
    31)
        #-----------------------------------------------------------------------
        # only attach and (re)create symlinks on PROLOG_UNDEPLOY
        #-----------------------------------------------------------------------
        ATTACH_ONLY="ATTACH_ONLY (LCM_STATE=$LCM_STATE PROLOG_UNDEPLOY)"
        DO_SYMLINK="yes"
    ;;
    60)
        #-----------------------------------------------------------------------
        # detach from all and attach to dst on PROLOG_MIGRATE_UNKNOWN
        #-----------------------------------------------------------------------
        MIGRATE_UNKNOWN="yes"
        DETACH_ALL=1
        DO_SYMLINK="yes"
        SKIP_CONTEXT=1
        date >>"/tmp/one-${VM_ID}-${DISK_ID}-iso.skip"
    ;;
    *)
        splog ">>> STATE=$VMSTATE LCM_STATE=$LCM_STATE <<<"
    ;;
esac


#-------------------------------------------------------------------------------
# check if it is called in SYSTEM_DS context
#-------------------------------------------------------------------------------
if [ "$DS_TEMPLATE_TYPE" = "SYSTEM_DS" ]; then
    ssh_make_path "$DST_HOST" "$DST_DIR" "storpool"
    TEMPLATE=`onevm show -x "$VM_ID" | base64 -w0`
    oneTemplateInfo "$TEMPLATE"
    if [ $IS_DISK == 0 ]; then
        # checkpoint
        if [ -n "$CHECKPOINT_SAVE" ]; then
            oneCheckpointSave "$SRC"
        fi
        if [ -n "$CHECKPOINT_RESTORE" ]; then
            oneCheckpointRestore "$DST"
        fi
        # context ISO. Do detach/attach only when hosts differ
        if [ -n "$_CONTEXT_DISK_ID" ]; then
            SP_VOL="one-sys-${VM_ID}-${_CONTEXT_DISK_ID}-iso"
            if [ "$SRC_HOST" != "$DST_HOST" ]; then
                SP_LINK="/dev/storpool/$SP_VOL"
                CTX_PATH="$DST_DIR/${VM_ID}/disk.${_CONTEXT_DISK_ID}"
                if [ -n "$ATTACH_ONLY" ]; then
                    splog "$ATTACH_ONLY"
                else
                    storpoolVolumeDetach "$SP_VOL" "force" "$SRC_HOST" "$DETACH_ALL"
                fi
                if [ -n "$DETACH_ONLY" ]; then
                    splog "$DETACH_ONLY"
                else
                    storpoolVolumeAttach "$SP_VOL" "$DST_HOST" "ro"
                    if [ "$DO_SYMLINK" = "yes" ]; then
                        oneSymlink "$DST_HOST" "$SP_LINK" "$CTX_PATH" "${CTX_PATH}.iso"
                    fi
                fi
                if [ -n "$SKIP_CONTEXT" ]; then
                    skip_context_ts="$(date -u)"
                    echo "$skip_context_ts" >"/tmp/one-${VM_ID}-${_CONTEXT_DISK_ID}-iso.skip"
                    splog "create /tmp/one-${VM_ID}-${_CONTEXT_DISK_ID}-iso.skip ($skip_context_ts)"
                fi
            fi
        fi
        if [ "$SRC_PATH" != "$DST_PATH" ]; then
            splog "Change the CONTEXT image template to one-ds-$DS_ID"
            storpoolVolumeTemplate "$SP_VOL" "one-ds-$DS_ID"
        fi
        # other files in the VM home
        SRC_DS_DIR=`dirname  $SRC_PATH`
        SRC_VM_DIR=`basename $SRC_PATH`
        if [ $DS_SHARED != "YES" ] || [ "$SP_SYSTEM" = "ssh" ]; then
            if [ "$SRC_HOST" = "$DST_HOST" ] || [ "$MIGRATE_UNKNOWN" = "yes" ]; then
                if [ "$SRC_PATH" = "$DST_PATH" ]; then
                    splog "VM $VM_ID on same path($SRC_PATH)${MIGRATE_UNKNOWN:+ MIGRATE_UNKNOWN}"
                else
                    splog "datastore change $SRC_PATH -> $DST_PATH"
                    ssh_exec_and_log "$DST_HOST" "mv -n -t $DST_PATH $SRC_PATH/*" \
                        "Failed moving $SRC_PATH/* to $DST_PATH"
                fi
            else
                TAR_SSH=$(cat <<EOF
set -e -o pipefail
logger -t "tm_sp_mv_r[\$\$]" -- "$TAR -C $SRC_DS_DIR --sparse -cf - $SRC_VM_DIR | $SSH $DST_HOST '$TAR -C $DST_DIR --sparse -xf -'"
$TAR -C "$SRC_DS_DIR" --sparse -cf - "$SRC_VM_DIR" | $SSH "$DST_HOST" '$TAR -C "$DST_DIR" --sparse -xf -;logger -t "tm_sp_mv_r[\$\$]" -- "rDone \$? \\$?"'
logger -t "tm_sp_mv_r[\$\$]" -- "rm -rf $SRC_PATH"
rm -rf "$SRC_PATH"
logger -t "tm_sp_mv_r[\$\$]" -- "END"
EOF
)
                splog "Transfering $SRC_HOST:$SRC_PATH to $DST_HOST:$DST_DIR/$SRC_VM_DIR"
                ssh_exec_and_log "$SRC_HOST" "eval $TAR_SSH" "Error transferring SYSTEM_DS from $SRC_HOST to $DST_HOST"
            fi
        fi
     else
        for i in ${!DISK_ID_ARRAY[@]}; do
            if [ "${DISK_TM_ARRAY[i]}" = "" ]; then
                DISK_PATH="$DST_PATH"
                FORMAT="${DISK_FORMAT_ARRAY[i]:-raw}"
                if [ ${DISK_TYPE_ARRAY[i]} = "swap" ]; then
                    FORMAT="swap"
                fi
                if [ $IS_DISK == 1 ]; then
                    if [ "${DISK_ID_ARRAY[i]}" != "$DISK_ID" ] ; then
                        continue
                    fi
                else
                    DISK_PATH="${DST_PATH}/disk.${DISK_ID_ARRAY[i]}"
                fi
                SP_VOL="one-sys-${VM_ID}-${DISK_ID_ARRAY[i]}-${FORMAT}"
                SP_LINK="/dev/storpool/$SP_VOL"
                if [ -n "$ATTACH_ONLY" ]; then
                    splog "$ATTACH_ONLY"
                else
                    storpoolVolumeDetach "$SP_VOL" "force" "$SRC_HOST" "$DETACH_ALL"
                fi
                if [ -n "$DETACH_ONLY" ]; then
                    splog "$DETACH_ONLY"
                else
                    storpoolVolumeAttach "$SP_VOL" "$DST_HOST"
                    if [ "$DO_SYMLINK" = "yes" ]; then
                        oneSymlink "$DST_HOST" "$SP_LINK" "$DST_PATH"
                    fi
                fi
                if [ "$SRC_PATH" != "$DST_PATH" ]; then
                    storpoolVolumeTemplate "$SP_VOL" "one-ds-$DS_ID"
                fi
            fi
        done
     fi
     splog "END $VM_ID [SYSTEM_DS]"
     exit 0
else
    if [ -n "$ATTACH_ONLY" ]; then
        splog "$ATTACH_ONLY"
    else
        storpoolVolumeDetach "$SP_VOL" "force" "$SRC_HOST" "$DETACH_ALL" "$READONLY"
    fi
fi

#-------------------------------------------------------------------------------
# Do nothing on EPILOG_STOP, EPILOG_UNDEPLOY
#-------------------------------------------------------------------------------

if [ -n "$DETACH_ONLY" ]; then
    splog "END $VM_ID $DETACH_ONLY [IMAGE_DS]"
    exit 0
fi

#-------------------------------------------------------------------------------
# Enable the destination device
#-------------------------------------------------------------------------------

SP_VOL="${SOURCE##*/}"
if [ "$CLONE" = "YES" ]; then
    SP_VOL+="-${VM_ID}-${DISK_ID}"
fi

SP_LINK="/dev/storpool/$SP_VOL"

storpoolVolumeAttach "$SP_VOL" "$DST_HOST"
if [ "$DO_SYMLINK" = "yes" ]; then
    oneSymlink "$DST_HOST" "$SP_LINK" "$DST_PATH"
fi

splog "END $VM_ID [IMAGE_DS]"
exit 0
